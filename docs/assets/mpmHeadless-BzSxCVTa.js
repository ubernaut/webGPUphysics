import{i as q}from"./device-CAsdAK37.js";import{s as A,c as L,u as R,a as j}from"./diagnostics-DzI7hwxu.js";class N{constructor(t){this.device=t,this.domains=[]}addDomain(t){return this.domains.push(t),t}step(t,s){const o=!!s,c=s??this.device.createCommandEncoder({label:"engine-step"});let a=!1;for(const n of this.domains)!n||typeof n.step!="function"||(n.step.length>=2?(n.step(c,t),a=!0):n.step(t));if(!o){const n=c.finish();a&&this.device.queue.submit([n])}}}function $(e){const{device:t,particleCount:s,gridSize:o,iterations:c,constants:a,posVelBuffer:n,particleData:m,blockOptions:r={}}=e;if(!t)throw new Error("device is required");if(!s)throw new Error("particleCount is required");if(!o)throw new Error("gridSize {x,y,z} is required");const i=A(t,{particleCount:s,gridSize:o,posVelBuffer:n,constants:a,iterations:c}),l=m??L({count:s,gridSize:o,...r});R(t,i.buffers.particleBuffer,l);const M=new N(t);return M.addDomain(i.domain),{engine:M,...i,step:(p=a&&a.dt||.2)=>{const f=t.createCommandEncoder({label:"mpm-headless-step"});i.domain.step(f,p),t.queue.submit([f.finish()])}}}const S=document.getElementById("status"),G=document.getElementById("particleCount"),H=document.getElementById("gridSize"),U=document.getElementById("mass"),V=document.getElementById("massDelta"),W=document.getElementById("momentum"),J=document.getElementById("momentumDelta"),X=document.getElementById("checks"),b=document.getElementById("toggleBtn"),Y=document.getElementById("resetBtn"),K=document.getElementById("error"),Q=["Hydrogen","Oxygen","Sodium","Potassium","Magnesium","Aluminum","Silicon","Calcium","Titanium","Iron","Lead"];let E=null,u=!0,O=0,w=0,I=!1,d=null;const Z=.01,tt=.01,F=.005,k=[.8,.8,1,1.1,.95,1,.95,1.1,1,1,1],et=[2e-4,2e-4,3e-4,3e-4,25e-5,2e-4,15e-5,25e-5,18e-5,17e-5,16e-5],nt=[.05,.05,.08,.1,.07,.05,.05,.08,.06,.05,.05];function ot(e,t,s){const o=Math.max(0,Math.min(e,k.length-1)),c=k[o],a=et[o],n=nt[o],m=t-300;let r=c*(1+a*m);const i=1/Math.max(.2,1+.1*(s-1));r*=i,r=Math.min(Math.max(r,.4),2.5);let l=n+Math.abs(m)*1e-4+Math.max(0,s-1)*.02;return l=Math.min(Math.max(l,0),.6),{spacing:r,jitter:l}}const v={stiffness:2.5,restDensity:4,dynamicViscosity:.08,dt:F,fixedPointScale:1e5};function h(e){S.textContent=e}function z(e){console.error(e),K.textContent=(e==null?void 0:e.stack)||String(e),h("error"),u=!1,b.disabled=!0}b.addEventListener("click",()=>{u=!u,b.textContent=u?"Pause":"Resume",h(u?"running":"paused")});Y.addEventListener("click",()=>{d=null,S.textContent="baseline reset"});async function st(){try{let f=function(P){if(u&&E&&(E.step(),window.__mpmStarted=!0,p+=1),E&&!I&&P-O>500&&(I=!0,O=P,j(e,E.buffers.particleBuffer,s).then(({mass:y,momentum:C})=>{w=w*.7+.3*2,U.textContent=y.toFixed(4),W.textContent=C.map(g=>g.toFixed(4)).join(", "),d||(d={mass:y,momentum:C});const B=d?y-d.mass:0,x=d?C.map((g,T)=>g-d.momentum[T]):[0,0,0];V.textContent=B.toExponential(3),J.textContent=x.map(g=>g.toExponential(3)).join(", ");const _=Math.hypot(x[0],x[1],x[2]);Math.abs(B)>Z||_>tt?S.textContent=`drift detected (Δm=${B.toExponential(2)}, |Δp|=${_.toExponential(2)})`:u&&(S.textContent="running"),X.textContent=w.toFixed(1)}).catch(z).finally(()=>{I=!1})),m>0&&p>=m){window.__mpmDone=!0,window.__mpmStepsRan=p;return}requestAnimationFrame(f)};h("initializing WebGPU…");const{device:e}=await q(),t=new URLSearchParams(window.location.search),s=parseInt(t.get("count")||"1000",10),o={x:32,y:32,z:32},c=t.get("material")||"Oxygen",a=Math.max(0,Q.indexOf(c)),n=t.get("temp"),m=parseInt(t.get("steps")||"0",10);h("creating MLS-MPM…");const r=Math.ceil(Math.cbrt(s)),i=ot(a,n?parseFloat(n):300,v.ambientPressure||1),l={start:[2,2,2],gridSize:o,jitter:i.jitter,spacing:i.spacing,materialType:a,cubeSideCount:r,temperature:n?parseFloat(n):void 0},D=Math.ceil(.05/F);E=$({device:e,particleCount:s,gridSize:o,iterations:D,blockOptions:l,constants:v}),window.__mpmStarted=!1,G.textContent=s.toString(),H.textContent=`${o.x}×${o.y}×${o.z}`,h("running");let p=0;requestAnimationFrame(f)}catch(e){z(e)}}st();
