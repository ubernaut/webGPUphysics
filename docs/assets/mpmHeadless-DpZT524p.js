import{i as z}from"./device-CAsdAK37.js";import{s as v,c as L,u as O,a as q}from"./diagnostics-DzI7hwxu.js";class T{constructor(t){this.device=t,this.domains=[]}addDomain(t){return this.domains.push(t),t}step(t,n){const c=!!n,r=n??this.device.createCommandEncoder({label:"engine-step"});let s=!1;for(const o of this.domains)!o||typeof o.step!="function"||(o.step.length>=2?(o.step(r,t),s=!0):o.step(t));if(!c){const o=r.finish();s&&this.device.queue.submit([o])}}}function F(e){const{device:t,particleCount:n,gridSize:c,iterations:r,constants:s,posVelBuffer:o,particleData:C,blockOptions:D={}}=e;if(!t)throw new Error("device is required");if(!n)throw new Error("particleCount is required");if(!c)throw new Error("gridSize {x,y,z} is required");const l=v(t,{particleCount:n,gridSize:c,posVelBuffer:o,constants:s,iterations:r}),E=C??L({count:n,gridSize:c,...D});O(t,l.buffers.particleBuffer,E);const d=new T(t);return d.addDomain(l.domain),{engine:d,...l,step:(u=s&&s.dt||.2)=>{const m=t.createCommandEncoder({label:"mpm-headless-step"});l.domain.step(m,u),t.queue.submit([m.finish()])}}}const y=document.getElementById("status"),$=document.getElementById("particleCount"),A=document.getElementById("gridSize"),j=document.getElementById("mass"),H=document.getElementById("massDelta"),R=document.getElementById("momentum"),U=document.getElementById("momentumDelta"),_=document.getElementById("checks"),M=document.getElementById("toggleBtn"),G=document.getElementById("resetBtn"),N=document.getElementById("error"),V=["Hydrogen","Oxygen","Sodium","Potassium","Magnesium","Aluminum","Silicon","Calcium","Titanium","Iron","Lead"];let f=null,a=!0,I=0,B=0,S=!1,i=null;const W=.01,Y=.01,P=.005,J={stiffness:2.5,restDensity:4,dynamicViscosity:.08,dt:P,fixedPointScale:1e5};function g(e){y.textContent=e}function w(e){console.error(e),N.textContent=(e==null?void 0:e.stack)||String(e),g("error"),a=!1,M.disabled=!0}M.addEventListener("click",()=>{a=!a,M.textContent=a?"Pause":"Resume",g(a?"running":"paused")});G.addEventListener("click",()=>{i=null,y.textContent="baseline reset"});async function K(){try{let E=function(d){a&&f&&f.step(),f&&!S&&d-I>500&&(S=!0,I=d,q(e,f.buffers.particleBuffer,t).then(({mass:h,momentum:u})=>{B=B*.7+.3*2,j.textContent=h.toFixed(4),R.textContent=u.map(p=>p.toFixed(4)).join(", "),i||(i={mass:h,momentum:u});const m=i?h-i.mass:0,x=i?u.map((p,k)=>p-i.momentum[k]):[0,0,0];H.textContent=m.toExponential(3),U.textContent=x.map(p=>p.toExponential(3)).join(", ");const b=Math.hypot(x[0],x[1],x[2]);Math.abs(m)>W||b>Y?y.textContent=`drift detected (Δm=${m.toExponential(2)}, |Δp|=${b.toExponential(2)})`:a&&(y.textContent="running"),_.textContent=B.toFixed(1)}).catch(w).finally(()=>{S=!1})),requestAnimationFrame(E)};g("initializing WebGPU…");const{device:e}=await z(),t=4e3,n={x:32,y:32,z:32},r=new URLSearchParams(window.location.search).get("material")||"Oxygen",s=Math.max(0,V.indexOf(r));g("creating MLS-MPM…");const o=Math.ceil(Math.cbrt(t)),C={start:[2,2,2],gridSize:n,jitter:.25,spacing:.65,materialType:s,cubeSideCount:o},l=Math.ceil(.05/P);f=F({device:e,particleCount:t,gridSize:n,iterations:l,blockOptions:C,constants:J}),$.textContent=t.toString(),A.textContent=`${n.x}×${n.y}×${n.z}`,g("running"),requestAnimationFrame(E)}catch(e){w(e)}}K();
