import{i as S}from"./device-CAsdAK37.js";import{s as k,c as I,u as z,a as v}from"./diagnostics-DDWoSuSw.js";class w{constructor(t){this.device=t,this.domains=[]}addDomain(t){return this.domains.push(t),t}step(t,o){const m=!!o,a=o??this.device.createCommandEncoder({label:"engine-step"});let s=!1;for(const n of this.domains)!n||typeof n.step!="function"||(n.step.length>=2?(n.step(a,t),s=!0):n.step(t));if(!m){const n=a.finish();s&&this.device.queue.submit([n])}}}function P(e){const{device:t,particleCount:o,gridSize:m,iterations:a,constants:s,posVelBuffer:n,particleData:d,blockOptions:u={}}=e;if(!t)throw new Error("device is required");if(!o)throw new Error("particleCount is required");if(!m)throw new Error("gridSize {x,y,z} is required");const i=k(t,{particleCount:o,gridSize:m,posVelBuffer:n,constants:s,iterations:a}),g=d??I({count:o,gridSize:m,...u});z(t,i.buffers.particleBuffer,g);const c=new w(t);return c.addDomain(i.domain),{engine:c,...i,step:(M=s&&s.dt||.2)=>{const C=t.createCommandEncoder({label:"mpm-headless-step"});i.domain.step(C,M),t.queue.submit([C.finish()])}}}const E=document.getElementById("status"),q=document.getElementById("particleCount"),O=document.getElementById("gridSize"),F=document.getElementById("mass"),L=document.getElementById("massDelta"),$=document.getElementById("momentum"),j=document.getElementById("momentumDelta"),A=document.getElementById("checks"),y=document.getElementById("toggleBtn"),G=document.getElementById("resetBtn"),R=document.getElementById("error");let p=null,l=!0,b=0,h=0,x=!1,r=null;const T=.01,U=.01,V={stiffness:2.5,restDensity:4,dynamicViscosity:.08,dt:.05,fixedPointScale:1e7};function f(e){E.textContent=e}function D(e){console.error(e),R.textContent=(e==null?void 0:e.stack)||String(e),f("error"),l=!1,y.disabled=!0}y.addEventListener("click",()=>{l=!l,y.textContent=l?"Pause":"Resume",f(l?"running":"paused")});G.addEventListener("click",()=>{r=null,E.textContent="baseline reset"});async function W(){try{let a=function(s){l&&p&&p.step(),p&&!x&&s-b>500&&(x=!0,b=s,v(e,p.buffers.particleBuffer,t).then(({mass:n,momentum:d})=>{h=h*.7+.3*2,F.textContent=n.toFixed(4),$.textContent=d.map(c=>c.toFixed(4)).join(", "),r||(r={mass:n,momentum:d});const u=r?n-r.mass:0,i=r?d.map((c,B)=>c-r.momentum[B]):[0,0,0];L.textContent=u.toExponential(3),j.textContent=i.map(c=>c.toExponential(3)).join(", ");const g=Math.hypot(i[0],i[1],i[2]);Math.abs(u)>T||g>U?E.textContent=`drift detected (Δm=${u.toExponential(2)}, |Δp|=${g.toExponential(2)})`:l&&(E.textContent="running"),A.textContent=h.toFixed(1)}).catch(D).finally(()=>{x=!1})),requestAnimationFrame(a)};f("initializing WebGPU…");const{device:e}=await S(),t=4e3,o={x:32,y:32,z:32};f("creating MLS-MPM…"),p=P({device:e,particleCount:t,gridSize:o,iterations:1,blockOptions:{start:[2,2,2],gridSize:o,jitter:.5,spacing:.65},constants:V}),q.textContent=t.toString(),O.textContent=`${o.x}×${o.y}×${o.z}`,f("running"),requestAnimationFrame(a)}catch(e){D(e)}}W();
