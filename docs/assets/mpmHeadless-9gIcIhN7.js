import{i as I}from"./device-CAsdAK37.js";import{s as k,c as z,u as P,a as v}from"./diagnostics-BsSKq56m.js";class w{constructor(t){this.device=t,this.domains=[]}addDomain(t){return this.domains.push(t),t}step(t,n){const c=!!n,d=n??this.device.createCommandEncoder({label:"engine-step"});let s=!1;for(const o of this.domains)!o||typeof o.step!="function"||(o.step.length>=2?(o.step(d,t),s=!0):o.step(t));if(!c){const o=d.finish();s&&this.device.queue.submit([o])}}}function q(e){const{device:t,particleCount:n,gridSize:c,iterations:d,constants:s,posVelBuffer:o,particleData:E,blockOptions:u={}}=e;if(!t)throw new Error("device is required");if(!n)throw new Error("particleCount is required");if(!c)throw new Error("gridSize {x,y,z} is required");const i=k(t,{particleCount:n,gridSize:c,posVelBuffer:o,constants:s,iterations:d}),p=E??z({count:n,gridSize:c,...u});P(t,i.buffers.particleBuffer,p);const a=new w(t);return a.addDomain(i.domain),{engine:a,...i,step:(r=s&&s.dt||.2)=>{const h=t.createCommandEncoder({label:"mpm-headless-step"});i.domain.step(h,r),t.queue.submit([h.finish()])}}}const x=document.getElementById("status"),F=document.getElementById("particleCount"),L=document.getElementById("gridSize"),O=document.getElementById("mass"),$=document.getElementById("massDelta"),j=document.getElementById("momentum"),A=document.getElementById("momentumDelta"),T=document.getElementById("checks"),D=document.getElementById("toggleBtn"),_=document.getElementById("resetBtn"),G=document.getElementById("error");let f=null,m=!0,S=0,C=0,B=!1,l=null;const H=.01,R=.01,M=.005,U={stiffness:2.5,restDensity:4,dynamicViscosity:.08,dt:M,fixedPointScale:1e5};function g(e){x.textContent=e}function b(e){console.error(e),G.textContent=(e==null?void 0:e.stack)||String(e),g("error"),m=!1,D.disabled=!0}D.addEventListener("click",()=>{m=!m,D.textContent=m?"Pause":"Resume",g(m?"running":"paused")});_.addEventListener("click",()=>{l=null,x.textContent="baseline reset"});async function V(){try{let o=function(E){m&&f&&f.step(),f&&!B&&E-S>500&&(B=!0,S=E,v(e,f.buffers.particleBuffer,t).then(({mass:u,momentum:i})=>{C=C*.7+.3*2,O.textContent=u.toFixed(4),j.textContent=i.map(r=>r.toFixed(4)).join(", "),l||(l={mass:u,momentum:i});const p=l?u-l.mass:0,a=l?i.map((r,h)=>r-l.momentum[h]):[0,0,0];$.textContent=p.toExponential(3),A.textContent=a.map(r=>r.toExponential(3)).join(", ");const y=Math.hypot(a[0],a[1],a[2]);Math.abs(p)>H||y>R?x.textContent=`drift detected (Δm=${p.toExponential(2)}, |Δp|=${y.toExponential(2)})`:m&&(x.textContent="running"),T.textContent=C.toFixed(1)}).catch(b).finally(()=>{B=!1})),requestAnimationFrame(o)};g("initializing WebGPU…");const{device:e}=await I(),t=4e3,n={x:32,y:32,z:32};g("creating MLS-MPM…");const c={start:[2,2,2],gridSize:n,jitter:.5,spacing:.65},s=Math.ceil(.05/M);f=q({device:e,particleCount:t,gridSize:n,iterations:s,blockOptions:c,constants:U}),F.textContent=t.toString(),L.textContent=`${n.x}×${n.y}×${n.z}`,g("running"),requestAnimationFrame(o)}catch(e){b(e)}}V();
